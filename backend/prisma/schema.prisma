generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
  SUPPORT
  VENDOR
}

enum AuthProvider {
  LOCAL
  GOOGLE
  GITHUB
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
  REFUNDED
  FAILED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

model User {
  id              String       @id @default(uuid())
  email           String       @unique
  password        String?      // Nullable for OAuth
  firstName       String?
  lastName        String?
  avatar          String?
  role            Role         @default(USER)
  provider        AuthProvider @default(LOCAL)
  providerId      String?
  
  isEmailVerified Boolean      @default(false)
  isActive        Boolean      @default(true)
  lastLogin       DateTime?

  // Relations
  orders          Order[]
  cart            Cart?
  reviews         Review[]
  enquiries       Enquiry[]
  feedback        Feedback[]
  addresses       Address[]
  
  // Referrals
  referralCode    String?      @unique
  referredBy      String?      // Code of the person who referred this user
  referralCount   Int          @default(0)
  totalRewards    Decimal      @default(0.00) @db.Decimal(10, 2)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([email])
  @@index([referralCode])
  @@map("users")
}

model Address {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  street    String
  city      String
  state     String
  country   String
  zipCode   String
  isDefault Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("addresses")
}

model Product {
  id            String        @id @default(uuid())
  slug          String        @unique
  title         String
  description   String        @db.Text
  content       String?       @db.LongText // For full rich text content
  price         Decimal       @default(0.00) @db.Decimal(10, 2)
  comparePrice  Decimal?      @db.Decimal(10, 2)
  currency      String        @default("USD")
  
  sku           String?       @unique
  stock         Int           @default(0)
  status        ProductStatus @default(DRAFT)
  
  // Media
  thumbnail     String?
  images        Json?         // Array of image strings
  
  // SEO
  metaTitle     String?
  metaDesc      String?
  keywords      String?

  // Relations
  reviews       Review[]
  orderItems    OrderItem[]
  cartItems     CartItem[]
  categoryId    String?
  category      Category?     @relation(fields: [categoryId], references: [id])

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([slug])
  @@index([status])
  @@map("products")
}

model Category {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?   
  
  parentId    String?
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  
  products    Product[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("categories")
}

model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique // One cart per user
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  items     CartItem[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("carts")
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  
  quantity  Int      @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId]) // Prevent duplicate items in same cart
  @@map("cart_items")
}

model Order {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  
  orderNumber     String      @unique
  status          OrderStatus @default(PENDING)
  
  totalAmount     Decimal     @db.Decimal(10, 2)
  taxAmount       Decimal     @default(0) @db.Decimal(10, 2)
  shippingAmount  Decimal     @default(0) @db.Decimal(10, 2)
  discountAmount  Decimal     @default(0) @db.Decimal(10, 2)
  currency        String      @default("USD")

  // Payment
  paymentStatus   PaymentStatus @default(PENDING)
  paymentMethod   String?
  transactionId   String?

  // Addresses Snapshot
  shippingAddress Json
  billingAddress  Json

  items           OrderItem[]
  invoice         Invoice?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId])
  @@index([orderNumber])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  
  quantity  Int
  price     Decimal  @db.Decimal(10, 2) // Price at time of purchase
  total     Decimal  @db.Decimal(10, 2)

  @@map("order_items")
}

model Invoice {
  id        String   @id @default(uuid())
  orderId   String   @unique
  order     Order    @relation(fields: [orderId], references: [id])
  
  invoiceNo String   @unique
  url       String?  // PDF URL

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("invoices")
}

model Review {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  rating    Int      // 1-5
  comment   String?  @db.Text
  isVerified Boolean @default(false)
  isVisible Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("reviews")
}

// Support & Feedback

model Enquiry {
  id        String   @id @default(uuid())
  userId    String?  // Optional, can be guest
  user      User?    @relation(fields: [userId], references: [id])
  
  name      String
  email     String
  subject   String
  message   String   @db.Text
  status    String   @default("OPEN") // OPEN, CLOSED, IN_PROGRESS

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("enquiries")
}

model Feedback {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  type      String   // BUG, FEATURE, GENERAL
  message   String   @db.Text
  rating    Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("feedback")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  resource  String
  details   Json?
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())

  @@map("audit_logs")
}
